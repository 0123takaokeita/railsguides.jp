<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"    content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="keywords"    content="Ruby Rails ガイド 体系的 入門 無料" />
    <meta name="author"      content="Ruby on Rails Community" />

    <meta property="fb:admins"      content="715330868" />
    <meta property="og:title"       content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:site_name"   content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:image"       content="https://railsguides.jp/images/cover_for_facebook.png"/>
    <meta property="og:url"         content="https://railsguides.jp/" />
    <meta property="og:type"        content="article" />
    <meta property="og:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />

    <meta name="twitter:card"  content="summary" />
    <meta name="twitter:site"  content="@RailsGuidesJP" />
    <meta name="twitter:title" content="Ruby on Rails ガイド：体系的に Rails を学ぼう" />
    <meta name="twitter:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="twitter:image" content="https://railsguides.jp/images/cover_for_twitter.png" />
    <meta name="twitter:url"   content="https://railsguides.jp/" />

    <title>Action Cable の概要 | Rails ガイド</title>
    <meta name="apple-mobile-web-app-title" content="Railsガイド" />
    <meta name="application-name"           content="Railsガイド" />

    <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

    <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

    <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
<body class="guide">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=614116885378153&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">関連サイト: </strong>
      <span class="red-button more-info-button">関連URL</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://guides.rubyonrails.org/">原著 (英語)</a></li>
        <li class="more-info"><a href="https://github.com/yasslab/railsguides.jp">ソースコード (GitHub)</a></li>
        <li class="more-info"><a href="https://railstutorial.jp/">Rails チュートリアル</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="/" title="Return to home page">railsguides.jp</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="/">ホーム</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">ガイド目次</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>はじめに</dt>
                <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
                <dt>モデル</dt>
                <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
                <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
                <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
                <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
                <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
                <dt>ビュー</dt>
                <dd><a href="action_view_overview.html">Action View の概要</a></dd>
                <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
                <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
                <dt>コントローラ</dt>
                <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
                <dd><a href="routing.html">Rails ルーティング</a></dd>
              </dl>
              <dl class="R">
                <dt>高度なトピック</dt>
                <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
                <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
                <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
                <dd><a href="testing.html">Rails テスティングガイド</a></dd>
                <dd><a href="security.html">Rails セキュリティガイド</a></dd>
                <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
                <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
                <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
                <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
                <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
                <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
                <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
                <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
                <dd><a href="profiling.html">Rails アプリのプロファイリング</a></dd>
                <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
                <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
                <dt>Rails を拡張する</dt>
                <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
                <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
                <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
                <dd><a href="engines.html">Rails エンジン入門</a></dd>
                <dt>Ruby on Rails に貢献する</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
                <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
                <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
                <dt>メンテナンスポリシー</dt>
                <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
                <dt>リリースノート</dt>
                <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
                <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="https://github.com/yasslab/railsguides.jp#readme">翻訳に貢献する</a></li>
        <li><a class="nav-item" href="credits.html">原著者</a></li>
        <li><a class="nav-item" href="options.html">電子書籍 (検索対応)</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">ガイド目次</option>
              <optgroup label="はじめに">
                  <option value="getting_started.html">Rails をはじめよう</option>
              </optgroup>
              <optgroup label="モデル">
                  <option value="active_record_basics.html">Active Record の基礎</option>
                  <option value="active_record_migrations.html">Active Record マイグレーション</option>
                  <option value="active_record_validations.html">Active Record バリデーション</option>
                  <option value="active_record_callbacks.html">Active Record コールバック</option>
                  <option value="association_basics.html">Active Record の関連付け</option>
                  <option value="active_record_querying.html">Active Record クエリインターフェイス</option>
                  <option value="active_model_basics.html">Active Model の基礎</option>
              </optgroup>
              <optgroup label="ビュー">
                  <option value="action_view_overview.html">Action View の概要</option>
                  <option value="layouts_and_rendering.html">レイアウトとレンダリング</option>
                  <option value="form_helpers.html">Action View フォームヘルパー</option>
              </optgroup>
              <optgroup label="コントローラ">
                  <option value="action_controller_overview.html">Action Controller の概要</option>
                  <option value="routing.html">Rails ルーティング</option>
              </optgroup>
              <optgroup label="高度なトピック">
                  <option value="active_support_core_extensions.html">Active Support コア拡張機能</option>
                  <option value="i18n.html">Rails 国際化 (i18n) API</option>
                  <option value="action_mailer_basics.html">Action Mailer の基礎</option>
                  <option value="active_job_basics.html">Active Job の基礎</option>
                  <option value="testing.html">Rails テスティングガイド</option>
                  <option value="security.html">Rails セキュリティガイド</option>
                  <option value="debugging_rails_applications.html">Rails アプリケーションのデバッグ</option>
                  <option value="configuring.html">Rails アプリケーションを設定する</option>
                  <option value="command_line.html">コマンドラインツールと Rake タスク</option>
                  <option value="asset_pipeline.html">アセットパイプライン</option>
                  <option value="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</option>
                  <option value="initialization.html">Rails の初期化プロセス</option>
                  <option value="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</option>
                  <option value="caching_with_rails.html">Rails のキャッシュ: 概要</option>
                  <option value="active_support_instrumentation.html">Active Support の Instrumentation 機能</option>
                  <option value="profiling.html">Rails アプリのプロファイリング</option>
                  <option value="api_app.html">Rails による API 専用アプリ</option>
                  <option value="action_cable_overview.html">Action Cable の概要</option>
              </optgroup>
              <optgroup label="Rails を拡張する">
                  <option value="plugins.html">Rails プラグイン作成入門</option>
                  <option value="rails_on_rack.html">Rails と Rack</option>
                  <option value="generators.html">Rails ジェネレータとテンプレート入門</option>
                  <option value="engines.html">Rails エンジン入門</option>
              </optgroup>
              <optgroup label="Ruby on Rails に貢献する">
                  <option value="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</option>
                  <option value="development_dependencies_install.html">Rails コア開発環境の構築方法</option>
                  <option value="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</option>
              </optgroup>
              <optgroup label="メンテナンスポリシー">
                  <option value="maintenance_policy.html">メンテナンスポリシー</option>
              </optgroup>
              <optgroup label="リリースノート">
                  <option value="upgrading_ruby_on_rails.html">Rails アップグレードガイド</option>
                  <option value="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />
  <div id="feature">
  <div class="wrapper">
      <h2>Action Cable の概要</h2><p>本ガイドでは、Action Cableのしくみと、WebSocketsをRailsアプリケーションに導入してリアルタイム機能を実現する方法について解説します。</p><p>このガイドの内容:</p>
<ul>
<li>Action Cableの概要、バックエンドとフロントエンドの統合</li>
<li>Action Cableの設定方法</li>
<li>チャネルの設定方法</li>
<li>Action Cable向けのデプロイとアーキテクチャの設定</li>
</ul>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />目次</h3>
            <ol class="chapters">
<li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li>
<li><a href="#pub-sub%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">Pub/Subについて</a></li>
<li>
<a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88">サーバー側のコンポーネント</a>

<ul>
<li><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88-%E6%8E%A5%E7%B6%9A">接続</a></li>
<li><a href="#%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB">チャネル</a></li>
</ul>
</li>
<li>
<a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88">クライアント側のコンポーネント</a>

<ul>
<li><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88-%E6%8E%A5%E7%B6%9A">接続</a></li>
</ul>
</li>
<li>
<a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E9%96%93%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A">クライアント-サーバー間のやりとり</a>

<ul>
<li><a href="#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0">ストリーム</a></li>
<li><a href="#%E3%83%96%E3%83%AD%E3%83%BC%E3%83%89%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88">ブロードキャスト</a></li>
<li><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E9%96%93%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A-%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">サブスクリプション</a></li>
<li><a href="#%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%81%AB%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E6%B8%A1%E3%81%99">チャネルにパラメータを渡す</a></li>
<li><a href="#%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%92%E5%86%8D%E3%83%96%E3%83%AD%E3%83%BC%E3%83%89%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B">メッセージを再ブロードキャストする</a></li>
</ul>
</li>
<li>
<a href="#%E3%83%95%E3%83%AB%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%81%AE%E4%BE%8B">フルスタックの例</a>

<ul>
<li><a href="#%E4%BE%8B1-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%A2%E3%83%94%E3%82%A2%E3%83%A9%E3%83%B3%E3%82%B9%E3%81%AE%E8%A1%A8%E7%A4%BA">例1: ユーザーアピアランスの表示</a></li>
<li><a href="#%E4%BE%8B2-%E6%96%B0%E3%81%97%E3%81%84web%E9%80%9A%E7%9F%A5%E3%82%92%E5%8F%97%E4%BF%A1%E3%81%99%E3%82%8B">例2: 新しいweb通知を受信する</a></li>
<li><a href="#%E3%82%88%E3%82%8A%E8%A9%B3%E3%81%97%E3%81%84%E4%BE%8B">より詳しい例</a></li>
</ul>
</li>
<li>
<a href="#%E8%A8%AD%E5%AE%9A">設定</a>

<ul>
<li><a href="#%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%80%E3%83%97%E3%82%BF">サブスクリプションアダプタ</a></li>
<li><a href="#%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%9F%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E9%80%81%E4%BF%A1%E5%85%83">許可されたリクエスト送信元</a></li>
<li><a href="#%E3%82%B3%E3%83%B3%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%9E%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A">コンシューマーの設定</a></li>
<li><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%A8%AD%E5%AE%9A">その他の設定</a></li>
</ul>
</li>
<li>
<a href="#action-cable%E5%B0%82%E7%94%A8%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B">Action Cable専用サーバーを実行する</a>

<ul>
<li><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%A7%E5%AE%9F%E8%A1%8C">アプリで実行</a></li>
<li><a href="#%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E3%82%A2%E3%83%AD%E3%83%B3">スタンドアロン</a></li>
<li><a href="#%E3%83%A1%E3%83%A2">メモ</a></li>
</ul>
</li>
<li><a href="#%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82">依存関係</a></li>
<li><a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4">デプロイ</a></li>
</ol>

          </div>
</div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="はじめに"><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1 はじめに</a></h3><p>Action Cableは、
<a href="https://ja.wikipedia.org/wiki/WebSocket">WebSockets</a>とRailsのその他の部分をシームレスに統合するためのものです。Action Cable が導入されたことで、Rails アプリケーションの効率の良さとスケーラビリティを損なわずに、通常のRailsアプリケーションと同じスタイル・方法でリアルタイム機能をRubyで記述できます。クライアント側のJavaScriptフレームワークとサーバー側のRubyフレームワークを同時に提供する、フルスタックのフレームワークです。Active RecordなどのORMで書かれたすべてのドメインモデルにアクセスできます。</p><h3 id="pub-subについて"><a href="#pub-sub%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">2 Pub/Subについて</a></h3><p><a href="https://ja.wikipedia.org/wiki/%E5%87%BA%E7%89%88-%E8%B3%BC%E8%AA%AD%E5%9E%8B%E3%83%A2%E3%83%87%E3%83%AB">Pub/Sub</a>はパブリッシュ/サブスクライブとも呼ばれる、メッセージキューのパラダイムです。パブリッシャ（送信者）が、サブスクライバ（受信者）の抽象クラスに情報を送信します。
このとき、個別の受信者を指定しません。Action Cableでは、このアプローチを採用してサーバーと多数のクライアント間で通信を行います。</p><h3 id="サーバー側のコンポーネント"><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88">3 サーバー側のコンポーネント</a></h3><h4 id="サーバー側のコンポーネント-接続"><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88-%E6%8E%A5%E7%B6%9A">3.1 接続</a></h4><p><em>接続</em>（connection）は、クライアントとサーバー間の関係を成立させる基礎となります。サーバーでWebSocketを受け付けるたびに、接続オブジェクトがインスタンス化します。このオブジェクトは、今後作成されるすべての<em>チャネルサブスクリプション</em>の親となります。この接続自体は、認証や承認の後、特定のアプリケーションロジックを扱いません。WebSocket接続のクライアントは<em>コンシューマー</em>と呼ばれます。各ユーザーが開くブラウザタブ、ウィンドウ、デバイスごとに、コンシューマー接続ペアが1つずつ作成されます。</p><p>接続は、<code>ApplicationCable::Connection</code>のインスタンスです。このクラスでは、着信接続を承認し、ユーザーを特定できた場合に接続を確立します。</p><h5 id="接続の設定"><a href="#%E6%8E%A5%E7%B6%9A%E3%81%AE%E8%A8%AD%E5%AE%9A">3.1.1 接続の設定</a></h5><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/application_cable/connection.rb
module ApplicationCable
  class Connection &lt; ActionCable::Connection::Base
    identified_by :current_user

    def connect
      self.current_user = find_verified_user
    end

    protected
      def find_verified_user
        if current_user = User.find_by(id: cookies.signed[:user_id])
          current_user
        else
          reject_unauthorized_connection
        end
      end
  end
end

</pre>
</div>
<p>上の<code>identified_by</code>は接続IDであり、後で特定の接続を見つけるときに利用できます。IDとしてマークされたものは、その接続以外で作成されるすべてのチャネルインスタンスに、同じ名前で自動的にデリゲートを作成します。</p><p>この例では、アプリケーションの他の場所で既にユーザー認証を扱っており、認証成功によってユーザーIDに署名済みcookieが設定されていることを前提としています。</p><p>次に、新しい接続を求められたときにこのcookieが接続インスタンスに自動で送信され、<code>current_user</code>の設定に使われます。現在の同じユーザーによる接続が識別されると、そのユーザーが開いているすべての接続を取得することも、ユーザーが削除されたり認証できない場合に切断することもできるようになります。</p><h4 id="チャネル"><a href="#%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB">3.2 チャネル</a></h4><p><em>チャネル</em>は、論理的な作業単位をカプセル化します。通常のMVC設定でコントローラが果たす役割と似ています。Railsはデフォルトで、チャネル間で共有されるロジックをカプセル化する<code>ApplicationCable::Channel</code>という親クラスを作成します。</p><h5 id="親チャネルの設定"><a href="#%E8%A6%AA%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A">3.2.1 親チャネルの設定</a></h5><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/application_cable/channel.rb
module ApplicationCable
  class Channel &lt; ActionCable::Channel::Base
  end
end

</pre>
</div>
<p>上のコードによって、専用のChannelクラスを作成します。たとえば、
<code>ChatChannel</code>や<code>AppearanceChannel</code>などは次のように作成します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
end

# app/channels/appearance_channel.rb
class AppearanceChannel &lt; ApplicationCable::Channel
end

</pre>
</div>
<p>これで、コンシューマはこうしたチャネルをサブスクライブできるようになります。</p><h5 id="チャネル-サブスクリプション"><a href="#%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB-%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">3.2.2 サブスクリプション</a></h5><p>コンシューマーは、チャネルをサブスクライブする<em>サブスクライバ</em>の役割を果たします。そして、コンシューマーの接続は<em>サブスクリプション</em>と呼ばれます。生成されたメッセージは、Action Cableコンシューマーが送信するIDに基いて、これらのチャネルサブスクリプションにルーティングされます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  # コンシューマーがこのチャネルのサブスクライバになると
  # このコードが呼び出される
  def subscribed
  end
end

</pre>
</div>
<h3 id="クライアント側のコンポーネント"><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88">4 クライアント側のコンポーネント</a></h3><h4 id="クライアント側のコンポーネント-接続"><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88-%E6%8E%A5%E7%B6%9A">4.1 接続</a></h4><p>コンシューマー側でも、接続のインスタンスが必要になります。この接続は、Railsがデフォルトで生成する次のJavaScriptコードによって確立します。</p><h5 id="コンシューマーの接続"><a href="#%E3%82%B3%E3%83%B3%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%9E%E3%83%BC%E3%81%AE%E6%8E%A5%E7%B6%9A">4.1.1 コンシューマーの接続</a></h5><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
// app/assets/javascripts/cable.js
//= require action_cable
//= require_self
//= require_tree ./channels

(function() {
  this.App || (this.App = {});

  App.cable = ActionCable.createConsumer();
}).call(this);

</pre>
</div>
<p>これにより、サーバーの<code>/cable</code>にデフォルトで接続するコンシューマーが準備されます。利用したいサブスクリプションが指定されていない場合、接続は確立しません。</p><h5 id="サブスクライバ"><a href="#%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%A9%E3%82%A4%E3%83%90">4.1.2 サブスクライバ</a></h5><p>指定のチャネルにサブスクリプションを作成することで、コンシューマーがサブスクライバになります。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
# app/assets/javascripts/cable/subscriptions/chat.coffee
App.cable.subscriptions.create { channel: "ChatChannel", room: "Best Room" }

# app/assets/javascripts/cable/subscriptions/appearance.coffee
App.cable.subscriptions.create { channel: "AppearanceChannel" }

</pre>
</div>
<p>サブスクリプションは上のコードで作成されます。受信したデータに応答する機能については後述します。</p><p>コンシューマーは、指定のチャネルに対するサブスクライバとして振る舞うことができます。回数の制限はありません。たとえば、コンシューマーはチャットルームを同時にいくつでもサブスクライブできます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
App.cable.subscriptions.create { channel: "ChatChannel", room: "1st Room" }
App.cable.subscriptions.create { channel: "ChatChannel", room: "2nd Room" }

</pre>
</div>
<h3 id="クライアント-サーバー間のやりとり"><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E9%96%93%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A">5 クライアント-サーバー間のやりとり</a></h3><h4 id="ストリーム"><a href="#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0">5.1 ストリーム</a></h4><p><em>ストリーム</em>は、ブロードキャストでパブリッシュするコンテンツをサブスクライバにルーティングする機能をチャネルに提供します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_from "chat_#{params[:room]}"
  end
end

</pre>
</div>
<p>あるモデルに関連するストリームを作成すると、利用するブロードキャストがそのモデルとチャネルから生成されます。次の例 では、<code>comments:Z2lkOi8vVGVzdEFwcC9Qb3N0LzE</code>のような形式のブロードキャストにサブスクライブします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CommentsChannel &lt; ApplicationCable::Channel
  def subscribed
    post = Post.find(params[:id])
    stream_for post
  end 
end

</pre>
</div>
<p>これで、このチャネルに次のようにブロードキャストできるようになります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
CommentsChannel.broadcast_to(@post, @comment)

</pre>
</div>
<h4 id="ブロードキャスト"><a href="#%E3%83%96%E3%83%AD%E3%83%BC%E3%83%89%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88">5.2 ブロードキャスト</a></h4><p><em>ブロードキャスト</em>（broadcasting）は、pub/subのリンクです。パブリッシャーからの送信内容はすべてブロードキャスト経由を経由し、その名前のブロードキャストをストリーミングするチャネルサブスクライバに直接ルーティングされます。各チャネルは、0個以上のブロードキャストをストリーミングできます。</p><p>ブロードキャストは純粋なオンラインキューであり、時間に依存します。ストリーミング（指定のチャンネルへのサブスクライブ）を行っていないコンシューマーは、後で接続するときにブロードキャストを取得できません。</p><p>ブロードキャストは、Railsアプリケーションの別の場所で呼び出されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
WebNotificationsChannel.broadcast_to(
  current_user,
  title: 'New things!',
  body: 'All the news fit to print'
)

</pre>
</div>
<p><code>WebNotificationsChannel.broadcast_to</code>呼び出しでは、現在のサブスクリプションアダプタ（デフォルトはRedis）のpubsubキューにメッセージを設定します。ユーザーごとに異なるブロードキャスト名が使用されます。IDが1のユーザーなら、ブロードキャスト名は<code>web_notifications_1</code>のようになります。</p><p><code>received</code>コールバックを呼び出すことで、このチャネルは<code>web_notifications_1</code>に着信するものをすべてクライアントに直接ストリーミングするようになります。</p><h4 id="クライアント-サーバー間のやりとり-サブスクリプション"><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E9%96%93%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A-%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">5.3 サブスクリプション</a></h4><p>チャネルにサブスクライブしたコンシューマーは、サブスクライバとして振る舞います。この接続はサブスクリプションと呼ばれます。着信メッセージは、Action Cableコンシューマーが送信するIDに基いて、これらのチャネルサブスクリプションにルーティングされます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
# app/assets/javascripts/cable/subscriptions/chat.coffee
# web通知の送信権をサーバーからリクエスト済みであることが前提
App.cable.subscriptions.create { channel: "ChatChannel", room: "Best Room" },
  received: (data) -&gt;
    @appendLine(data)

  appendLine: (data) -&gt;
    html = @createLine(data)
    $("[data-chat-room='Best Room']").append(html)

  createLine: (data) -&gt;
    """
    &lt;article class="chat-line"&gt;
      &lt;span class="speaker"&gt;#{data["sent_by"]}&lt;/span&gt;
      &lt;span class="body"&gt;#{data["body"]}&lt;/span&gt;
    &lt;/article&gt;
    """

</pre>
</div>
<h4 id="チャネルにパラメータを渡す"><a href="#%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%81%AB%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E6%B8%A1%E3%81%99">5.4 チャネルにパラメータを渡す</a></h4><p>サブスクリプション作成時に、クライアント側のパラメータをサーバー側に渡すことができます。以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_from "chat_#{params[:room]}"
  end
end

</pre>
</div>
<p><code>subscriptions.create</code>に最初の引数として渡されるオブジェクトは、Action Cableチャネルのparamsハッシュになります。キーワード<code>channel</code>の指定は省略できません。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
# app/assets/javascripts/cable/subscriptions/chat.coffee
App.cable.subscriptions.create { channel: "ChatChannel", room: "Best Room" },
  received: (data) -&gt;
    @appendLine(data)

  appendLine: (data) -&gt;
    html = @createLine(data)
    $("[data-chat-room='Best Room']").append(html)

  createLine: (data) -&gt;
    """
    &lt;article class="chat-line"&gt;
      &lt;span class="speaker"&gt;#{data["sent_by"]}&lt;/span&gt;
      &lt;span class="body"&gt;#{data["body"]}&lt;/span&gt;
    &lt;/article&gt;
    """

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# このコードはアプリのどこかで呼び出される
# おそらくNewCommentJobなどのあたりで
ChatChannel.broadcast_to(
  "chat_#{room}",
  sent_by: 'Paul',
  body: 'This is a cool chat app. '
)

</pre>
</div>
<h4 id="メッセージを再ブロードキャストする"><a href="#%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%92%E5%86%8D%E3%83%96%E3%83%AD%E3%83%BC%E3%83%89%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E3%81%99%E3%82%8B">5.5 メッセージを再ブロードキャストする</a></h4><p>あるクライアントから、接続している別のクライアントに、メッセージを<em>再ブロードキャスト</em>することはよくあります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/chat_channel.rb
class ChatChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_from "chat_#{params[:room]}"
  end

  def receive(data)
    ChatChannel.broadcast_to("chat_#{params[:room]}", data)
  end
end

</pre>
</div>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
# app/assets/javascripts/cable/subscriptions/chat.coffee
App.chatChannel = App.cable.subscriptions.create { channel: "ChatChannel", room: "Best Room" },
  received: (data) -&gt;
    # data =&gt; { sent_by: "Paul", body: "This is a cool chat app." }

App.chatChannel.send({ sent_by: "Paul", body: "This is a cool chat app." })

</pre>
</div>
<p>再ブロードキャストは、接続しているすべてのクライアントで受信されます。送信元クライアント自身も再ブロードキャストを受信します。利用するparamsは、チャネルにサブスクライブするときと同じです。</p><h3 id="フルスタックの例"><a href="#%E3%83%95%E3%83%AB%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%81%AE%E4%BE%8B">6 フルスタックの例</a></h3><p>以下の設定手順は、2つの例で共通です。</p>
<ol>
<li>
<a href="#connection-setup">接続を設定</a>.</li>
<li>
<a href="#parent-channel-setup">親チャネルを設定</a>.</li>
<li>
<a href="#connect-consumer">コンシューマーを接続</a>.</li>
</ol>
<h4 id="例1-ユーザーアピアランスの表示"><a href="#%E4%BE%8B1-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%A2%E3%83%94%E3%82%A2%E3%83%A9%E3%83%B3%E3%82%B9%E3%81%AE%E8%A1%A8%E7%A4%BA">6.1 例1: ユーザーアピアランスの表示</a></h4><p>これは、ユーザーがオンラインかどうか、ユーザーがどのページを開いているかという情報を追跡するチャネルの簡単な例です（オンラインユーザーの横に緑の点を表示する機能を作成する場合などに便利です）。</p><p>サーバー側のアピアランスチャネルを作成します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/appearance_channel.rb
class AppearanceChannel &lt; ApplicationCable::Channel
  def subscribed
    current_user.appear
  end

  def unsubscribed
    current_user.disappear
  end

  def appear(data)
    current_user.appear(on: data['appearing_on'])
  end

  def away
    current_user.away
  end
end

</pre>
</div>
<p>サブスクリプションが開始されると、<code>subscribed</code>コールバックがトリガーされ、そのユーザーがオンラインであることが示されます。このアピアランスAPIをRedisやデータベースなどと連携することもできます。</p><p>クライアント側のアピアランスチャネルを作成します。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
# app/assets/javascripts/cable/subscriptions/appearance.coffee
App.cable.subscriptions.create "AppearanceChannel",
  # サブスクリプションがサーバー側で利用可能になると呼び出される
  connected: -&gt;
    @install()
    @appear()

  # WebSocket接続が閉じると呼び出される
  disconnected: -&gt;
    @uninstall()

  # サブスクリプションがサーバーに拒否されると呼び出される
  rejected: -&gt;
    @uninstall()

  appear: -&gt;
    # サーバーの`AppearanceChannel#appear(data)`を呼び出す
    @perform("appear", appearing_on: $("main").data("appearing-on"))

  away: -&gt;
    # サーバーの`AppearanceChannel#away`を呼び出す
    @perform("away")


  buttonSelector = "[data-behavior~=appear_away]"

  install: -&gt;
    $(document).on "page:change.appearance", =&gt;
      @appear()

    $(document).on "click.appearance", buttonSelector, =&gt;
      @away()
      false

    $(buttonSelector).show()

  uninstall: -&gt;
    $(document).off(".appearance")
    $(buttonSelector).hide()

</pre>
</div>
<h6 id="例1-ユーザーアピアランスの表示-クライアント-サーバー間のやりとり"><a href="#%E4%BE%8B1-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%A2%E3%83%94%E3%82%A2%E3%83%A9%E3%83%B3%E3%82%B9%E3%81%AE%E8%A1%A8%E7%A4%BA-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E9%96%93%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A">6.1.1 クライアント-サーバー間のやりとり</a></h6>
<ol>
<li><p><strong>クライアント</strong>は<strong>サーバー</strong>に<code>App.cable = ActionCable.createConsumer("ws://cable.example.com")</code>経由で接続する（<code>cable.js</code>）。<strong>サーバー</strong>は、この接続の認識に<code>current_user</code>を使う。</p></li>
<li><p><strong>クライアント</strong>はアピアランスチャネルに<code>App.cable.subscriptions.create(channel: "AppearanceChannel")</code>経由で接続する（<code>appearance.coffee</code>）</p></li>
<li><p><strong>サーバー</strong>は、アピアランスチャネル向けに新しいサブスクリプションを開始したことを認識し、サーバーの<code>subscribed</code>コールバックを呼び出し、<code>current_user</code>の<code>appear</code>メソッドを呼び出す。（<code>appearance_channel.rb</code>）</p></li>
<li><p><strong>クライアント</strong>は、サブスクリプションが確立したことを認識し、<code>connected</code>（<code>appearance.coffee</code>）を呼び出す。これにより、<code>@install</code>と<code>@appear</code>が呼び出される。<code>@appear</code>はサーバーの<code>AppearanceChannel#appear(data)</code>を呼び出して<code>{ appearing_on: $("main").data("appearing-on") }</code>のデータハッシュを渡す。なお、この動作が可能なのは、クラスで宣言されている（コールバックを除く）全パブリックメソッドが、サーバー側のチャネルインスタンスから自動的に公開されるからです。公開されたパブリックメソッドは、サブスクリプションで<code>perform</code>メソッドを使って、RPC（リモートプロシージャコール）として利用できます。</p></li>
<li><p><strong>サーバー</strong>は、<code>current_user</code>で認識した接続のアピアランスチャネルで、<code>appear</code>アクションへのリクエストを受信する。（<code>appearance_channel.rb</code>）<strong>サーバー</strong>は<code>:appearing_on</code>キーを使ってデータをデータハッシュから取り出し、
<code>current_user.appear</code>に渡される<code>:on</code>キーの値として設定する。</p></li>
</ol>
<h4 id="例2-新しいweb通知を受信する"><a href="#%E4%BE%8B2-%E6%96%B0%E3%81%97%E3%81%84web%E9%80%9A%E7%9F%A5%E3%82%92%E5%8F%97%E4%BF%A1%E3%81%99%E3%82%8B">6.2 例2: 新しいweb通知を受信する</a></h4><p>この例では、WebSocket接続を使って、サーバーからクライアント側の機能をリモート実行するときのアピアランスを扱います。WebSocketでは双方向通信を利用できます。そこで、例としてサーバーからクライアントでアクションを起動してみます。</p><p>このweb通知チャネルは、正しいストリームにブロードキャストを行ったときに、クライアント側でweb通知を表示します。</p><p>サーバー側のweb通知チャネルを作成します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/channels/web_notifications_channel.rb
class WebNotificationsChannel &lt; ApplicationCable::Channel
  def subscribed
    stream_for current_user
  end
end

</pre>
</div>
<p>クライアント側のweb通知チャネルを作成します。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
# app/assets/javascripts/cable/subscriptions/web_notifications.coffee
# クライアント側では、サーバーからweb通知の送信権を
# リクエスト済みであることが前提
App.cable.subscriptions.create "WebNotificationsChannel",
  received: (data) -&gt;
    new Notification data["title"], body: data["body"]

</pre>
</div>
<p>アプリケーションのどこからでも、web通知チャネルのインスタンスにコンテンツを送信できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# このコードはアプリのどこか（NewCommentJob あたり）で呼び出される
WebNotificationsChannel.broadcast_to(
  current_user,
  title: 'New things!',
  body: 'All the news fit to print'
)

</pre>
</div>
<p><code>WebNotificationsChannel.broadcast_to</code>呼び出しでは、現在のサブスクリプションアダプタのpubsubキューにメッセージを設定します。ユーザーごとに異なるブロードキャスト名が使用されます。IDが1のユーザーなら、ブロードキャスト名は<code>web_notifications_1</code>のようになります。</p><p><code>received</code>コールバックを呼び出すことで、このチャネルは<code>web_notifications_1</code>に着信するものをすべてクライアントに直接ストリーミングするようになります。引数として渡されたデータは、サーバー側のブロードキャスト呼び出しに2番目のパラメータとして渡されたハッシュです。このハッシュはJSONでエンコードされ、<code>received</code>で受信したときにデータ引数から取り出されます。</p><h4 id="より詳しい例"><a href="#%E3%82%88%E3%82%8A%E8%A9%B3%E3%81%97%E3%81%84%E4%BE%8B">6.3 より詳しい例</a></h4><p>RailsアプリにAction Cableを設定する方法やチャネルの追加方法については、<a href="https://github.com/rails/actioncable-examples">rails/actioncable-examples</a> で完全な例をご覧いただけます。</p><h3 id="設定"><a href="#%E8%A8%AD%E5%AE%9A">7 設定</a></h3><p>Action Cableで必須となる設定は、「サブスクリプションアダプタ」と「許可されたリクエスト送信元」の2つです。</p><h4 id="サブスクリプションアダプタ"><a href="#%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%80%E3%83%97%E3%82%BF">7.1 サブスクリプションアダプタ</a></h4><p>Action Cableは、デフォルトで<code>config/cable.yml</code>の設定ファイルを利用します。Railsの環境ごとに、アダプタとURLを1つずつ指定する必要があります。アダプタについて詳しくは、<a href="#%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82">依存関係</a> の節をご覧ください。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: async

test:
  adapter: async

production:
  adapter: redis
  url: redis://10.10.3.153:6381

</pre>
</div>
<h4 id="許可されたリクエスト送信元"><a href="#%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%9F%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E9%80%81%E4%BF%A1%E5%85%83">7.2 許可されたリクエスト送信元</a></h4><p>Action Cableは、指定されていない送信元からのリクエストを受け付けません。送信元リストは、配列の形でサーバー設定に渡します。送信元リストのインスタンスでは、文字列を利用することも、正規表現で一致をチェックすることもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_cable.allowed_request_origins = ['http://rubyonrails.com', %r{http://ruby.*}]

</pre>
</div>
<p>すべての送信元からのリクエストを許可または拒否するには、次を設定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_cable.disable_request_forgery_protection = true

</pre>
</div>
<p>development環境で実行中、Action Cableはlocalhost:3000からのすべてのリクエストをデフォルトで許可します。</p><h4 id="コンシューマーの設定"><a href="#%E3%82%B3%E3%83%B3%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%9E%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A">7.3 コンシューマーの設定</a></h4><p>URLを設定するには、HTMLレイアウトのHEADセクションに<code>action_cable_meta_tag</code>呼び出しを追加します。通常、ここで使うURLは、環境ごとの設定ファイルで<code>config.action_cable.url</code>に設定されます。</p><h4 id="その他の設定"><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%A8%AD%E5%AE%9A">7.4 その他の設定</a></h4><p>他にも、接続ごとのロガーにタグを保存するオプションがあります。次の例は、ユーザーアカウントIDがある場合はそれを使い、ない場合は「no-account」を使うタグ付けです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_cable.log_tags = [
  -&gt; request { request.env['user_account_id'] || "no-account" },
  :action_cable,
  -&gt; request { request.uuid }
]

</pre>
</div>
<p>利用可能なすべての設定オプションについては、<code>ActionCable::Server::Configuration</code>クラスをご覧ください。</p><p>もう1つ注意が必要な点があります。サーバーが提供するデータベース接続の数は、少なくともワーカー数を下回らないようにする必要があります。デフォルトのワーカープールサイズは4なので、データベース接続も4つは用意する必要があります。この値は、<code>config/database.yml</code>の<code>pool</code>属性で変更できます。</p><h3 id="action-cable専用サーバーを実行する"><a href="#action-cable%E5%B0%82%E7%94%A8%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B">8 Action Cable専用サーバーを実行する</a></h3><h4 id="アプリで実行"><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%A7%E5%AE%9F%E8%A1%8C">8.1 アプリで実行</a></h4><p>Action CableはRailsアプリケーションと一緒に実行できます。たとえば、<code>/websocket</code>でWebSocketリクエストをリッスンするには、<code>config.action_cable.mount_path</code>でパスを指定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/application.rb
class Application &lt; Rails::Application
  config.action_cable.mount_path = '/websocket'
end 

</pre>
</div>
<p>レイアウトで<code>action_cable_meta_tag</code>を呼び出すと、<code>App.cable = ActionCable.createConsumer()</code>でAction Cableサーバーに接続できるようになります。<code>createConsumer</code>の最初の引数にはカスタムパスが指定されます（例: <code>App.cable = ActionCable.createConsumer("/websocket")</code>）。</p><p>作成したサーバーの全インスタンスと、サーバーが作成した全ワーカーのインスタンスには、Action Cableの新しいインスタンスも含まれます。接続間のメッセージ同期は、Redisによって行われます。</p><h4 id="スタンドアロン"><a href="#%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E3%82%A2%E3%83%AD%E3%83%B3">8.2 スタンドアロン</a></h4><p>アプリケーション・サーバーとAction Cableサーバーを分けることもできます。Action CableサーバーはRackアプリケーションですが、独自のRackアプリケーションでもあります。推奨される基本設定は次のとおりです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# cable/config.ru
require_relative '../config/environment'
Rails.application.eager_load!

run ActionCable.server

</pre>
</div>
<p>続いて、 <code>bin/cable</code>のbinstubを使ってサーバーを起動します。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
#!/bin/bash
bundle exec puma -p 28080 cable/config.ru

</pre>
</div>
<p>ポート28080でAction Cableサーバーが起動します。</p><h4 id="メモ"><a href="#%E3%83%A1%E3%83%A2">8.3 メモ</a></h4><p>WebSocketサーバーからはセッションにアクセスできませんが、cookieにはアクセスできます。これを利用して認証を処理できます。<a href="http://www.rubytutorial.io/actioncable-devise-authentication">Action CableとDeviseでの認証</a> 記事をご覧ください。</p><h3 id="依存関係"><a href="#%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82">9 依存関係</a></h3><p>Action Cableは、自身のpubsub内部のプロセスへのサブスクリプションアダプタインターフェイスを提供します。非同期、インライン、PostgreSQL、イベント化Redis、非イベント化Redisなどのアダプタをデフォルトで利用できます。新規Railsアプリケーションのデフォルトアダプタは非同期（<code>async</code>）アダプタです。</p><p>Ruby側では、<a href="https://github.com/faye/websocket-driver-ruby">websocket-driver</a>、
<a href="https://github.com/celluloid/nio4r">nio4r</a>、<a href="https://github.com/ruby-concurrency/concurrent-ruby">concurrent-ruby</a>の上に構築されています。</p><h3 id="デプロイ"><a href="#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4">10 デプロイ</a></h3><p>Action Cableを支えているのは、WebSocketsとスレッドの組み合わせです。フレームワーク内部の流れや、ユーザー指定のチャネルの動作は、Rubyのネイティブスレッドによって処理されます。つまり、スレッドセーフを損なわない限り、Railsの正規のモデルはすべて問題なく利用できるということです。</p><p>Action Cableサーバーには、RackソケットをハイジャックするAPIが実装されています。これによって、アプリケーション・サーバーがマルチスレッドであるかどうかにかかわらず、内部の接続をマルチスレッドパターンで管理できます。</p><p>つまり、Action Cableは、Unicorn、Puma、Passengerなどの有名なサーバーと問題なく連携できるのです。</p>
        

        <h3 id="feedback"><a href="#feedback">フィードバックについて</a></h3>
        <p>
          本ガイドは GitHub上の <a href="https://github.com/yasslab/railsguides.jp">yasslab/railsguides.jp</a> で管理・公開されております。
          本ガイドを読んで気になる文章や間違ったコードを見かけたら、上記リポジトリにてお気軽に <a href="https://github.com/yasslab/railsguides.jp/issues">Issue</a> を出して頂けると嬉しいです。また、「Pull Request を送りたい!」という場合には、<a href="ruby_on_rails_guides_guidelines.html">Ruby on Railsガイドのガイドライン</a>と、<a href="https://github.com/yasslab/railsguides.jp#%E7%BF%BB%E8%A8%B3%E3%81%AE%E6%B5%81%E3%82%8C">README</a>に記載されている「翻訳の流れ」をご参考にしてください。
        </p>
        <p>
          なお、原著における間違いを見つけたら、「Ruby on Railsに貢献する方法」に記されている<a href="/contributing_to_ruby_on_rails.html#rails%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AB%E8%B2%A2%E7%8C%AE%E3%81%99%E3%82%8B">Railsのドキュメントに貢献する</a>を参考にしながら、ぜひRailsコミュニティに貢献してみてしてください :)
        </p>
        <p>
          本ガイドの品質向上に向けて、皆さまのご協力が得られれば幸いです。よろしくお願い致します。
        </p>
        <ol class="snsb" style="margin-left: 0px">
	  <li><div class="fb-like" data-href="https://railsguides.jp/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div></li>
	  <li><a href="https://twitter.com/share" class="twitter-share-button" data-url="https://railsguides.jp/" data-text="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-lang="en" data-hashtags="Railsガイド" data-via="RailsGuidesJP" width="100">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
          <li><iframe src="https://ghbtns.com/github-btn.html?user=yasslab&repo=railsguides.jp&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80" height="20"></iframe></li>
          <li><a href="https://b.hatena.ne.jp/entry/railsguides.jp" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></li>          
	  <li><div class="g-plusone" data-size="medium" data-lang="ja"></div>
	    <script type="text/javascript">
	      (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	      })();
	    </script>
	  </li>
        </ol>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <div class="sitemap">
          <dl class="L">
            <dt>はじめに</dt>
              <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
            <dt>モデル</dt>
              <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
              <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
              <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
              <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
              <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
              <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
              <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
            <dt>ビュー</dt>
              <dd><a href="action_view_overview.html">Action View の概要</a></dd>
              <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
              <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
            <dt>コントローラ</dt>
              <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
              <dd><a href="routing.html">Rails ルーティング</a></dd>
          </dl>
          <dl class="C">
            <dt>高度なトピック</dt>
              <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
              <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
              <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
              <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
              <dd><a href="testing.html">Rails テスティングガイド</a></dd>
              <dd><a href="security.html">Rails セキュリティガイド</a></dd>
              <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
              <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
              <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
              <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
              <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
              <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
              <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
              <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
              <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
              <dd><a href="profiling.html">Rails アプリのプロファイリング</a></dd>
              <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
              <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
            <dt>Rails を拡張する</dt>
              <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
              <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
              <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
              <dd><a href="engines.html">Rails エンジン入門</a></dd>
          </dl>
          <dl class="R">
            <dt>Ruby on Rails に貢献する</dt>
              <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
              <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
              <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
              <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
            <dt>メンテナンスポリシー</dt>
              <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
            <dt>リリースノート</dt>
              <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
              <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
              <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
              <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
              <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
              <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
              <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
              <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
              <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
              <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
          </dl>
      </div>

      <ol class="snsb" style="padding-top: 20px">
	<li>本ガイドは<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示-継承 4.0 国際</a> (CC BY-SA 4.0) ライセンスに基づいて公開されています。また、「Rails」および「Ruby on Rails」という名称、そして Rails のロゴは、David Heinemeier Hansson による登録商標で、すべての権利を有しています。</li>
      </ol>
    </div>
  </div>
</h5>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-50163209-4', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
