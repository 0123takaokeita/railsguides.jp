<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"    content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="keywords"    content="Ruby Rails ガイド 体系的 入門 無料" />
    <meta name="author"      content="Ruby on Rails Community" />

    <meta property="fb:admins"      content="715330868" />
    <meta property="og:title"       content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:site_name"   content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:image"       content="http://railsguides.jp/images/cover_for_facebook.png"/>
    <meta property="og:url"         content="http://railsguides.jp/" />
    <meta property="og:type"        content="article" />
    <meta property="og:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />

    <meta name="twitter:card"  content="summary" />
    <meta name="twitter:site"  content="@RailsGuidesJP" />
    <meta name="twitter:title" content="Ruby on Rails ガイド：体系的に Rails を学ぼう" />
    <meta name="twitter:description" content="Railsガイドは、Ruby on Rails Guidesに基づいた大型リファレンスガイドです。Rails開発の生産性を高めたいときや、Railsの各機能を体系的に学びたいときに役立ちます。" />
    <meta name="twitter:image" content="http://railsguides.jp/images/cover_for_twitter.png" />
    <meta name="twitter:url"   content="http://railsguides.jp/" />

    <title>Rails のキャッシュ: 概要 | Rails ガイド</title>
    <meta name="apple-mobile-web-app-title" content="Railsガイド" />
    <meta name="application-name"           content="Railsガイド" />

    <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

    <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

    <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
<body class="guide">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=614116885378153&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">関連サイト: </strong>
      <span class="red-button more-info-button">関連URL</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://guides.rubyonrails.org/">原著 (英語)</a></li>
        <li class="more-info"><a href="https://github.com/yasslab/railsguides.jp">ソースコード (GitHub)</a></li>
        <li class="more-info"><a href="http://railstutorial.jp/">Rails チュートリアル</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="/" title="Return to home page">railsguides.jp</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="/">ホーム</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">ガイド目次</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>はじめに</dt>
                <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
                <dt>モデル</dt>
                <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
                <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
                <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
                <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
                <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
                <dt>ビュー</dt>
                <dd><a href="action_view_overview.html">Action View の概要</a></dd>
                <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
                <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
                <dt>コントローラ</dt>
                <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
                <dd><a href="routing.html">Rails ルーティング</a></dd>
              </dl>
              <dl class="R">
                <dt>高度なトピック</dt>
                <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
                <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
                <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
                <dd><a href="testing.html">Rails テスティングガイド</a></dd>
                <dd><a href="security.html">Rails セキュリティガイド</a></dd>
                <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
                <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
                <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
                <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
                <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
                <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
                <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
                <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
                <dd><a href="profiling.html">Rails アプリケーションのプロファイリング</a></dd>
                <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
                <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
                <dt>Rails を拡張する</dt>
                <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
                <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
                <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
                <dd><a href="engines.html">Rails エンジン入門</a></dd>
                <dt>Ruby on Rails に貢献する</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
                <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
                <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
                <dt>メンテナンスポリシー</dt>
                <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
                <dt>リリースノート</dt>
                <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
                <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="https://github.com/yasslab/railsguides.jp#readme">翻訳に貢献する</a></li>
        <li><a class="nav-item" href="credits.html">原著者</a></li>
        <li><a class="nav-item" href="options.html">電子書籍 (検索対応)</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">ガイド目次</option>
              <optgroup label="はじめに">
                  <option value="getting_started.html">Rails をはじめよう</option>
              </optgroup>
              <optgroup label="モデル">
                  <option value="active_record_basics.html">Active Record の基礎</option>
                  <option value="active_record_migrations.html">Active Record マイグレーション</option>
                  <option value="active_record_validations.html">Active Record バリデーション</option>
                  <option value="active_record_callbacks.html">Active Record コールバック</option>
                  <option value="association_basics.html">Active Record の関連付け</option>
                  <option value="active_record_querying.html">Active Record クエリインターフェイス</option>
                  <option value="active_model_basics.html">Active Model の基礎</option>
              </optgroup>
              <optgroup label="ビュー">
                  <option value="action_view_overview.html">Action View の概要</option>
                  <option value="layouts_and_rendering.html">レイアウトとレンダリング</option>
                  <option value="form_helpers.html">Action View フォームヘルパー</option>
              </optgroup>
              <optgroup label="コントローラ">
                  <option value="action_controller_overview.html">Action Controller の概要</option>
                  <option value="routing.html">Rails ルーティング</option>
              </optgroup>
              <optgroup label="高度なトピック">
                  <option value="active_support_core_extensions.html">Active Support コア拡張機能</option>
                  <option value="i18n.html">Rails 国際化 (i18n) API</option>
                  <option value="action_mailer_basics.html">Action Mailer の基礎</option>
                  <option value="active_job_basics.html">Active Job の基礎</option>
                  <option value="testing.html">Rails テスティングガイド</option>
                  <option value="security.html">Rails セキュリティガイド</option>
                  <option value="debugging_rails_applications.html">Rails アプリケーションのデバッグ</option>
                  <option value="configuring.html">Rails アプリケーションを設定する</option>
                  <option value="command_line.html">コマンドラインツールと Rake タスク</option>
                  <option value="asset_pipeline.html">アセットパイプライン</option>
                  <option value="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</option>
                  <option value="initialization.html">Rails の初期化プロセス</option>
                  <option value="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</option>
                  <option value="caching_with_rails.html">Rails のキャッシュ: 概要</option>
                  <option value="active_support_instrumentation.html">Active Support の Instrumentation 機能</option>
                  <option value="profiling.html">Rails アプリケーションのプロファイリング</option>
                  <option value="api_app.html">Rails による API 専用アプリ</option>
                  <option value="action_cable_overview.html">Action Cable の概要</option>
              </optgroup>
              <optgroup label="Rails を拡張する">
                  <option value="plugins.html">Rails プラグイン作成入門</option>
                  <option value="rails_on_rack.html">Rails と Rack</option>
                  <option value="generators.html">Rails ジェネレータとテンプレート入門</option>
                  <option value="engines.html">Rails エンジン入門</option>
              </optgroup>
              <optgroup label="Ruby on Rails に貢献する">
                  <option value="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</option>
                  <option value="development_dependencies_install.html">Rails コア開発環境の構築方法</option>
                  <option value="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</option>
              </optgroup>
              <optgroup label="メンテナンスポリシー">
                  <option value="maintenance_policy.html">メンテナンスポリシー</option>
              </optgroup>
              <optgroup label="リリースノート">
                  <option value="upgrading_ruby_on_rails.html">Rails アップグレードガイド</option>
                  <option value="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />
  <div id="feature">
  <div class="wrapper">
      <h2>Rails のキャッシュ: 概要</h2><p>本ガイドでは、キャッシュを導入してRailsアプリケーションを高速化する方法をご紹介します。</p><p>「キャッシュ（caching）」とは、リクエスト・レスポンスのサイクルの中で生成されたコンテンツを保存しておき、次回同じようなリクエストが発生したときのレスポンスでそのコンテンツを再利用することを指します。</p><p>ほとんどの場合、キャッシュは、アプリケーションのパフォーマンスを効果的に増大するのに最適な方法です。キャッシュを導入することで、単一サーバー、単一データベースのwebサイトでも数千ユーザーの同時接続による負荷に耐えられるようになります。</p><p>Railsには、面倒な設定なしですぐ利用できるキャッシュ機能がひととおり用意されています。本ガイドで、それぞれの機能について目的を解説します。Railsのキャッシュ機能を使いこなすことで、応答時間の低下や高額なサーバー使用料に悩まされずに、Railsアプリケーションが数百万ビューをこなせるようになります。</p><p>このガイドの内容:</p>
<ul>
<li>フラグメントキャッシュとロシアンドールキャッシュ</li>
<li>キャッシュの依存関係の管理</li>
<li>代替キャッシュストア</li>
<li>条件付きGETのサポート</li>
</ul>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />目次</h3>
            <ol class="chapters">
<li>
<a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">基本的なキャッシュ</a>

<ul>
<li><a href="#%E3%83%9A%E3%83%BC%E3%82%B8%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">ページキャッシュ</a></li>
<li><a href="#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">アクションキャッシュ</a></li>
<li><a href="#%E3%83%95%E3%83%A9%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">フラグメントキャッシュ</a></li>
<li><a href="#%E3%83%AD%E3%82%B7%E3%82%A2%E3%83%B3%E3%83%89%E3%83%BC%E3%83%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">ロシアンドールキャッシュ</a></li>
<li><a href="#%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%81%AE%E7%AE%A1%E7%90%86">依存関係の管理</a></li>
<li><a href="#%E4%BD%8E%E3%83%AC%E3%83%99%E3%83%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">低レベルキャッシュ</a></li>
<li><a href="#sql-%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">SQL キャッシュ</a></li>
</ul>
</li>
<li>
<a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%B9%E3%83%88%E3%82%A2">キャッシュストア</a>

<ul>
<li><a href="#%E8%A8%AD%E5%AE%9A">設定</a></li>
<li><a href="#activesupport-cache-store">ActiveSupport::Cache::Store</a></li>
<li><a href="#activesupport-cache-memorystore">ActiveSupport::Cache::MemoryStore</a></li>
<li><a href="#activesupport-cache-filestore">ActiveSupport::Cache::FileStore</a></li>
<li><a href="#activesupport-cache-memcachestore">ActiveSupport::Cache::MemCacheStore</a></li>
<li><a href="#activesupport-cache-nullstore">ActiveSupport::Cache::NullStore</a></li>
</ul>
</li>
<li><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E3%82%AD%E3%83%BC">キャッシュのキー</a></li>
<li>
<a href="#%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8Dget%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88">条件付きGETのサポート</a>

<ul>
<li><a href="#%E5%BC%B7%E3%81%84etag%E3%81%A8%E5%BC%B1%E3%81%84etag">強いETagと弱いETag</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99">参考資料</a></li>
</ol>

          </div>
</div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="基本的なキャッシュ"><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1 基本的なキャッシュ</a></h3><p>ここでは、キャッシュの手法を3種類ご紹介します。「ページキャッシュ」「アクションキャッシュ」「フラグメントキャッシュ」です。Railsのフラグメントキャッシュは本体に組み込まれており、デフォルトで利用できます。ページキャッシュやアクションキャッシュを利用するには、Gemfileに<code>actionpack-page_caching</code> gemや<code>actionpack-action_caching</code> gemを追加する必要があります。</p><p>キャッシュは、デフォルトではproduction環境でのみ有効になります。ローカルでキャッシュを使ってみたい場合は、対応する<code>config/environments/*.rb</code>ファイルで<code>config.action_controller.perform_caching</code>を<code>true</code>に設定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_controller.perform_caching = true

</pre>
</div>
<div class="note"><p><code>config.action_controller.perform_caching</code>値の変更は、Action Controllerコンポーネントで提供されるキャッシュでのみ有効になります。つまり、後述する <a href="#low-level-caching">低レベルキャッシュ</a> の動作には影響しません。</p></div><h4 id="ページキャッシュ"><a href="#%E3%83%9A%E3%83%BC%E3%82%B8%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.1 ページキャッシュ</a></h4><p>Railsのページキャッシュは、apacheやnginxなどのwebサーバーによって生成されるページへのリクエストを（Railsスタック全体を経由せずに）キャッシュするメカニズムです。ページキャッシュはきわめて高速ですが、常に有効とは限りません。たとえば、認証にはページキャッシュは適用されません。また、webサーバーはファイルシステムから直接ファイルを読み出して利用するので、キャッシュの有効期限の実装も必要です。</p><div class="info"><p>ページキャッシュ機能は、Rails 4本体から取り除かれ、gem化されました。<a href="https://github.com/rails/actionpack-page_caching">actionpack-page_caching gem</a>をご覧ください。</p></div><h4 id="アクションキャッシュ"><a href="#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.2 アクションキャッシュ</a></h4><p>ページキャッシュは、before_filterのあるアクション（認証の必要なページなど）には適用できません。アクションキャッシュは、このような場合に使います。アクションキャッシュの動作は、ページキャッシュと似ていますが、webサーバーへのリクエストがRailsスタックにヒットしたときに、before_filterを実行してからキャッシュを返す点が異なります。これによって、キャッシュの恩恵を受けながら、認証などの制限をかけられるようになります。</p><div class="info"><p>アクションキャッシュ機能は、Rails 4本体から取り除かれ、gem化されました。<a href="https://github.com/rails/actionpack-action_caching">actionpack-action_caching gem</a>をご覧ください。新しい推奨メソッドについては、<a href="http://signalvnoise.com/posts/3113-how-key-based-cache-expiration-works">DHH's key-based cache expiration overview</a> をご覧ください。</p></div><h4 id="フラグメントキャッシュ"><a href="#%E3%83%95%E3%83%A9%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.3 フラグメントキャッシュ</a></h4><p>通常、動的なwebアプリケーションでは、ページのキャッシュ時の特性が異なるさまざまなコンポーネントによってページが生成されます。ページ内の異なる部品について、キャッシュや期限切れを個別に設定したい場合は、フラグメントキャッシュを使います。</p><p>フラグメントキャッシュでは、ビューのロジックのフラグメントをキャッシュブロックでラップし、次回のリクエストでそれをキャッシュストアから取り出して送信します。</p><p>たとえば、ページ内で表示する製品（product）を個別にキャッシュしたい場合、次のように書くことができます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;% @products.each do |product| %&gt;
  &lt;% cache product do %&gt;
    &lt;%= render product %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;

</pre>
</div>
<p>Railsアプリケーションが最初のリクエストを受信すると、一意のキーを備えた新しいキャッシュが保存されます。生成されるキーは次のようなものになります。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
views/products/1-201505056193031061005000/bea67108094918eeba42cd4a6e786901

</pre>
</div>
<p>キーの中間にある長い数字は、<code>product_id</code>と、productレコードの<code>updated_at</code>属性のタイムスタンプ値です。タイムスタンプ値は、古いデータを返さないようにするために使われます。<code>updated_at</code>値が更新されると新しいキーが生成され、そのキーで新しいキャッシュを保存します。古いキーで保存された古いキャッシュは二度と利用されなくなります。この手法は「キーベースの有効期限」と呼ばれます。</p><p>キャッシュされたフラグメントは、ビューのフラグメントが変更された場合（ビューのHTMLが変更された場合など）にも期限が切れます。キーの後半にある文字列は、「テンプレートツリーダイジェスト」です。これは、キャッシュされるビューフラグメントの内容から算出されたMD5ハッシュです。ビューフラグメントが変更されると、MD5ハッシュも変更され、既存のファイルが期限切れになります。</p><div class="info"><p>Memcachedなどのキャッシュストアでは、古いキャッシュファイルを自動的に削除します。</p></div><p>特定の条件を満たす場合にのみフラグメントをキャッシュしたい場合は、<code>cache_if</code>や<code>cache_unless</code>を使います。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;% cache_if admin?, product do %&gt;
  &lt;%= render product %&gt;
&lt;% end %&gt;

</pre>
</div>
<h5 id="コレクションキャッシュ"><a href="#%E3%82%B3%E3%83%AC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.3.1 コレクションキャッシュ</a></h5><p><code>render</code>ヘルパーでは、コレクションを指定して個別のテンプレートをレンダリングするときにもキャッシュを利用できます。上の例で<code>each</code>を使っているコードで、全キャッシュテンプレートを（個別に読み出す代わりに）一括で読み出すこともできます。この機能を利用するには、コレクションをレンダリングするときに<code>cached: true</code>を指定します。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;%= render partial: 'products/product', collection: @products, cached: true %&gt;

</pre>
</div>
<p>これにより、前回までにレンダリングされた全キャッシュテンプレートが一括で読み出され、劇的に速度が向上します。さらに、それまでキャッシュされていなかったテンプレートもキャッシュに追加され、次回のレンダリングでまとめて読み出されるようになります。</p><h4 id="ロシアンドールキャッシュ"><a href="#%E3%83%AD%E3%82%B7%E3%82%A2%E3%83%B3%E3%83%89%E3%83%BC%E3%83%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.4 ロシアンドールキャッシュ</a></h4><p>フラグメントキャッシュ内で、さらにフラグメントをキャッシュしたいことがあります。このようにキャッシュをネストする手法を、マトリョーシカ人形のイメージになぞらえて「ロシアンドールキャッシュ」（Russian doll caching）と呼びます。</p><p>ロシアンドールキャッシュを使うことで、たとえば内側のフラグメントで製品（product）が1件だけ更新された場合に、内側の他のフラグメントを捨てずに再利用し、外側のフラグメントは通常通り再生成できます。</p><p>前節で解説したように、キャッシュされたファイルは、そのファイルが直接依存しているレコードの<code>updated_at</code>の値が変わると期限切れになりますが、そのフラグメント内でネストするキャッシュは期限切れになりません。</p><p>次のビューを例に説明します。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;% cache product do %&gt;
  &lt;%= render product.games %&gt;
&lt;% end %&gt;

</pre>
</div>
<p>上のビューをレンダリングした後、次のビューをレンダリングします。</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;% cache game do %&gt;
  &lt;%= render game %&gt;
&lt;% end %&gt;

</pre>
</div>
<p>gameの属性で変更が発生すると、<code>updated_at</code>値が現在時刻で更新され、キャッシュが期限切れになります。しかし、productオブジェクトの<code>updated_at</code>は変更されないので、productのキャッシュは期限切れにならず、アプリケーションは古いデータを返します。これを修正したい場合は、次のように<code>touch</code>メソッドでモデル同士を結びつけます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Product &lt; ApplicationRecord
  has_many :games
end

class Game &lt; ApplicationRecord
  belongs_to :product, touch: true
end 

</pre>
</div>
<p><code>touch</code>をtrueに設定すると、gameのレコードの<code>updated_at</code>を更新するアクションを実行すると、関連付けられているproductの<code>updated_at</code>も同様に更新されてキャッシュの期限が終了します。</p><h4 id="依存関係の管理"><a href="#%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%81%AE%E7%AE%A1%E7%90%86">1.5 依存関係の管理</a></h4><p>キャッシュを正しく無効にするには、キャッシュの依存関係を適切に定義する必要があります。多くの場合、Railsでは依存関係が適切に処理されるので、特別な対応は不要です。ただし、カスタムヘルパーでキャッシュを扱うなどの場合は、明示的に依存関係を定義する必要があります。</p><h5 id="暗黙の依存関係"><a href="#%E6%9A%97%E9%BB%99%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82">1.5.1 暗黙の依存関係</a></h5><p>ほとんどの場合、テンプレートの依存関係は、テンプレート自身で呼び出される<code>render</code>によって発生します。以下の例は、<code>ActionView::Digestor</code>でデコード方法を扱うrender呼び出しです。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
render partial: "comments/comment", collection: commentable.comments
render "comments/comments"
render 'comments/comments'
render('comments/comments')

render "header" =&gt; render("comments/header")

render(@topic)         =&gt; render("topics/topic")
render(topics)         =&gt; render("topics/topic")
render(message.topics) =&gt; render("topics/topic")

</pre>
</div>
<p>一方、一部の呼び出しについて、キャッシュが適切に動作するよう変更が必要です。たとえば、独自のコレクションを渡す場合は、次のように変更する必要があります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
render @project.documents.where(published: true)

</pre>
</div>
<p>上のコードを次のように変更します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
render partial: "documents/document", collection: @project.documents.where(published: true)

</pre>
</div>
<h5 id="明示的な依存関係"><a href="#%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AA%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82">1.5.2 明示的な依存関係</a></h5><p>テンプレートで、思わぬ依存関係が生じることがあります。典型的なのは、ヘルパー内でレンダリングする場合です。以下に例を示します。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;%= render_sortable_todolists @project.todolists %&gt;

</pre>
</div>
<p>このような呼び出しには、次の特殊なコメント形式で明示的に依存関係を示す必要があります。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;%# Template Dependency: todolists/todolist %&gt;
&lt;%= render_sortable_todolists @project.todolists %&gt;

</pre>
</div>
<p>特殊なケース（単一テーブル継承の設定など）では、こうした明示的な依存関係を多数含むことがあります。個別のテンプレートを記述する代わりに、次のようにディレクトリ内の全テンプレートをワイルドカードで指定できます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;%# Template Dependency: events/* %&gt;
&lt;%= render_categorizable_events @person.events %&gt;

</pre>
</div>
<p>コレクションのキャッシュで、部分テンプレート（パーシャル）の冒頭でクリーンなキャッシュ呼び出しを行わない場合は、次の特殊コメント形式をテンプレートのどこかに追加することで、コレクションキャッシュを引き続き有効にできます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;%# Template Collection: notification %&gt;
&lt;% my_helper_that_calls_cache(some_arg, notification) do %&gt;
  &lt;%= notification.name %&gt;
&lt;% end %&gt;

</pre>
</div>
<h5 id="外部の依存関係"><a href="#%E5%A4%96%E9%83%A8%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82">1.5.3 外部の依存関係</a></h5><p>たとえば、キャッシュされたブロック内にヘルパーメソッドがあるとします。このヘルパーを更新するときに、キャッシュにもヒットしてしまわないよう、テンプレートファイルのMD5が何らかの方法で変更されるようにする必要があります。推奨される方法のひとつは、次のようにコメントで明示的に更新を示すことです。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;%# Helper Dependency Updated: Jul 28, 2015 at 7pm %&gt;
&lt;%= some_helper_method(person) %&gt;

</pre>
</div>
<h4 id="低レベルキャッシュ"><a href="#%E4%BD%8E%E3%83%AC%E3%83%99%E3%83%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.6 低レベルキャッシュ</a></h4><p>ビューのフラグメントをキャッシュするのではなく、特定の値やクエリ結果だけをキャッシュしたいことがあります。Railsのキャッシュメカニズムでは、どんな情報でもキャッシュに保存できます。</p><p>低レベルキャッシュの最も効果的な実装方法は、<code>Rails.cache.fetch</code>メソッドを利用することです。このメソッドは、キャッシュの書き込みと読み出しの両方に対応しています。引数が1つだけの場合、キーを読み出し、キャッシュから値を取り出して返します。ブロックを引数として渡すと、指定のキーでブロックの処理結果がキャッシュされ、その結果を返します。</p><p>次の例を考えてみましょう。アプリケーションに<code>Product</code>モデルがあり、競合webサイトの製品価格を検索するインスタンスメソッドがそのモデルにあるとします。低レベルキャッシュを使う場合、このメソッドから完全なデータが返ります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Product &lt; ApplicationRecord
  def competing_price
    Rails.cache.fetch("#{cache_key}/competing_price", expires_in: 12.hours) do
      Competitor::API.find_price(id)
    end
  end
end

</pre>
</div>
<div class="note"><p>上の例では<code>cache_key</code>メソッドを使っているので、キャッシュキーは<code>products/233-20140225082222765838000/competing_price</code>のような形式になります。<code>cache_key</code>で生成される文字列は、モデルの<code>id</code>と<code>updated_at</code>属性を元にしています。この生成ルールは一般的に使われており、productが更新されるたびにキャッシュを無効にできます。一般に、インスタンスレベルの情報に低レベルキャッシュを適用する場合、キャッシュキーを生成する必要があります。</p></div><h4 id="sql-キャッシュ"><a href="#sql-%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">1.7 SQL キャッシュ</a></h4><p>Railsのクエリキャッシュは、各クエリによって返った結果セットをキャッシュする機能です。リクエストによって以前と同じクエリが発生すると、データベースへのクエリを実行する代わりに、キャッシュされた結果セットを利用します。</p><p>以下に例を示します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ProductsController &lt; ApplicationController

def index
    # 検索クエリの実行
    @products = Product.all

    ... 

    # 同じクエリの再実行
    @products = Product.all
  end 

end

</pre>
</div>
<p>データベースに対して同じクエリが2回実行されると、実際にはデータベースにアクセスしません。1回目のクエリでは、結果をメモリ上のクエリキャッシュに保存し、2回目のクエリではメモリから結果を読み出します。</p><p>ただし、次の点にご注意ください。クエリキャッシュはアクションの開始時に作成され、アクションの終了時に破棄されます。従って、キャッシュはアクションの実行中しか保持されません。キャッシュをもっと持続させたい場合は、低レベルキャッシュを使います。</p><h3 id="キャッシュストア"><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%B9%E3%83%88%E3%82%A2">2 キャッシュストア</a></h3><p>Railsには、キャッシュデータの保存場所がいくつも用意されています。なお、SQLキャッシュやページキャッシュはこの中に含まれません。</p><h4 id="設定"><a href="#%E8%A8%AD%E5%AE%9A">2.1 設定</a></h4><p>アプリケーションのデフォルトのキャッシュストアは、<code>config.cache_store</code>オプションで設定できます。キャッシュストアのコンストラクタには、引数として他にもパラメータを渡せます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.cache_store = :memory_store, { size: 64.megabytes }

</pre>
</div>
<div class="note"><p>または、構成ブロックの外部で<code>ActionController::Base.cache_store</code>を呼び出すこともできます。</p></div><p>キャッシュにアクセスするには、<code>Rails.cache</code>を呼び出します。</p><h4 id="activesupport-cache-store"><a href="#activesupport-cache-store">2.2 ActiveSupport::Cache::Store</a></h4><p>このクラスは、Railsのキャッシュにアクセスするための基盤を提供します。抽象クラスであるため、直接利用できません。クラスを利用するには、ストレージエンジンに関連付けられたクラスを実装する必要があります。Railsでは以下が実装されています。</p><p>主要なメソッドは、<code>read</code>、<code>write</code>、<code>delete</code>、<code>exist?</code>、<code>fetch</code>です。fetchメソッドはブロックを1つ取り、キャッシュの値か、ブロックの評価を返します。既存の値がキャッシュにない場合は、結果をキャッシュに書き込みます。</p><p>いくつかのオプションについては、キャッシュのすべての実装で共通で利用できます。こうしたオプションは、コンストラクタに渡すことも、エントリーにアクセスするさまざまなメソッドに渡すこともできます。</p>
<ul>
<li><p><code>:namespace</code> - キャッシュストア内で名前空間を作成します。特に、キャッシュを他のアプリケーションと共有する場合に役立ちます。</p></li>
<li><p><code>:compress</code> - キャッシュ内での圧縮を有効にします。低速ネットワークで巨大なキャッシュエントリを転送する場合に役立ちます。</p></li>
<li><p><code>:compress_threshold</code> - <code>:compress</code>オプションと併用します。キャッシュのサイズが指定の閾値を下回る場合、圧縮しません。デフォルト値は16KBです。</p></li>
<li><p><code>:expires_in</code> - 指定の秒数が経過すると、キャッシュを自動で削除します。</p></li>
<li><p><code>:race_condition_ttl</code> - <code>:expires_in</code>と併用します。dog pile（乱闘）効果と呼ばれる競合状態を防止するのに使います。この競合状態は、マルチプロセスによって同じエントリが同時に再生成されたためにキャッシュの期限が切れた場合に発生します。このオプションでは、新しい値の再生成が完了していない状態で、期限切れのエントリを再利用してよい時間を秒で指定します。<code>:expires_in</code>オプションを利用する場合は、このオプションにも値を設定することをおすすめします。</p></li>
</ul>
<h5 id="カスタムのキャッシュストア"><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%B9%E3%83%88%E3%82%A2">2.2.1 カスタムのキャッシュストア</a></h5><p>キャッシュストアを独自に作成するには、<code>ActiveSupport::Cache::Store</code>をextendし、そこに適切なメソッドを実装します。これにより、Railsアプリケーションでさまざまなキャッシュ技術を差し替えることができます。</p><p>カスタムのキャッシュストアを利用するには、自作クラスの新しいインスタンスにキャッシュストアを設定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.cache_store = MyCacheStore.new

</pre>
</div>
<h4 id="activesupport-cache-memorystore"><a href="#activesupport-cache-memorystore">2.3 ActiveSupport::Cache::MemoryStore</a></h4><p>このキャッシュストアは、同じRubyプロセス内のメモリに保持されます。キャッシュストアのサイズを制限するには、イニシャライザに<code>:size</code>オプションを指定します（デフォルトは32MB）。キャッシュがこのサイズを超えるとクリーンアップが開始され、利用時期が最も古いエントリから削除されます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.cache_store = :memory_store, { size: 64.megabytes }

</pre>
</div>
<p>Ruby on Railsサーバーのプロセスを複数実行している場合（mongrel_clusterやPhusion Passengerを利用中の場合）、Railsサーバーのキャッシュデータはプロセスのインスタンス間で共有されません。このキャッシュストアは、大規模にデプロイされるアプリケーションには向いていません。ただし、小規模でトラフィックの少ないサイトでサーバープロセスを数個動かす程度であれば問題なく動作します。もちろん、development環境やtest環境でも動作します。</p><h4 id="activesupport-cache-filestore"><a href="#activesupport-cache-filestore">2.4 ActiveSupport::Cache::FileStore</a></h4><p>このキャッシュストアでは、エントリをファイルシステムに保存します。ファイル保存場所へのパスは、キャッシュを初期化するときに指定する必要があります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.cache_store = :file_store, "/path/to/cache/directory"

</pre>
</div>
<p>このキャッシュストアでは、複数のサーバープロセス間でキャッシュを共有できます。トラフィックが中規模程度のサイトを1、2個程度ホストする場合に向いています。異なるホストで実行するサーバープロセス間で、ファイルシステムによるキャッシュを共有することは一応可能ですが、おすすめできません。</p><p>ディスク容量がいっぱいになるほどキャッシュが増加する場合は、古いエントリを定期的に削除することをおすすめします。</p><p>これは、デフォルトのキャッシュストア実装です。</p><h4 id="activesupport-cache-memcachestore"><a href="#activesupport-cache-memcachestore">2.5 ActiveSupport::Cache::MemCacheStore</a></h4><p>このキャッシュストアでは、Dangaの<code>memcached</code>サーバーにアプリケーションのキャッシュを一元化保存します。Railsでは、本体にバンドルされている<code>dalli</code> gemをデフォルトで使います。現時点で、本番webサイトで最も広く利用されているキャッシュストアです。高性能かつ高冗長性を備えた、単一の共有キャッシュクラスタとして利用できます。</p><p>キャッシュの初期化時には、クラスタ内の全memcachedサーバーのアドレスを指定する必要があります。指定がない場合、memcachedがローカルのデフォルトポートで動作していると仮定して起動しますが、この設定は大規模サイトには向いていません。</p><p>このキャッシュの<code>write</code>メソッドや<code>fetch</code>メソッドでは、memcached固有の機能を利用する2つのオプションを指定できます。シリアル化を行わずに値を直接サーバーに送信するには、<code>:raw</code>を指定します。値は、文字列か数字を使用します。rawの値のみ、<code>increment</code>や<code>decrement</code>などを指定してmemcachedを直接操作できます。memcachedで既存エントリの上書きを許可しないようにするには、<code>:unless_exist</code>を指定します。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.cache_store = :mem_cache_store, "cache-1.example.com", "cache-2.example.com"

</pre>
</div>
<h4 id="activesupport-cache-nullstore"><a href="#activesupport-cache-nullstore">2.6 ActiveSupport::Cache::NullStore</a></h4><p>このキャッシュストア実装は、development環境やtest環境のみで使用され、実際にはキャッシュをまったく保存しません。これは、たとえば<code>Rails.cache</code>に直接アクセスするコードの効果が、キャッシュのせいで確認しづらい場合にきわめて便利です。このキャッシュストアを使うと、<code>fetch</code>や<code>read</code>はまったくヒットしなくなります。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.cache_store = :null_store

</pre>
</div>
<h3 id="キャッシュのキー"><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E3%82%AD%E3%83%BC">3 キャッシュのキー</a></h3><p>キャッシュのキーは、<code>cache_key</code>や<code>to_param</code>のいずれかに対応するオブジェクトになります。独自のキーを生成したい場合は、<code>cache_key</code>メソッドをクラスで実装してください。Active Recordでは、クラス名とレコードIDに基いてキーを生成します。</p><p>キャッシュのキーとして、値のハッシュや、値の配列を指定できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# 通常のキャッシュキー
Rails.cache.read(site: "mysite", owners: [owner_1, owner_2])

</pre>
</div>
<p><code>Rails.cache</code>のキーは、ストレージエンジンで実際に使われるキーと異なります。実際のキーは、名前空間によって修飾されたり、バックエンドの技術的制約に合わせて変更されていたりする可能性もあります。つまり、<code>Rails.cache</code>で値を保存してから<code>dalli</code> gemで値を取り出す、といったことはできません。その代わり、memcachedのサイズ制限や、構文規則違反について心配する必要もありません。</p><h3 id="条件付きgetのサポート"><a href="#%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8Dget%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88">4 条件付きGETのサポート</a></h3><p>条件付きGETは、HTTP仕様で定められた機能です。GETリクエストへのレスポンスが前回のリクエストからまったく変わっていない場合はブラウザ内キャッシュを使ってもよいと、webサーバーからブラウザに通知します。</p><p>この機能では、<code>HTTP_IF_NONE_MATCH</code>ヘッダと<code>HTTP_IF_MODIFIED_SINCE</code>ヘッダを使って、一意のコンテンツIDや最終変更タイムスタンプをやり取りします。コンテンツID（etag）か最終更新タイムスタンプが、サーバー側のバージョンと一致した場合は、サーバーから「変更なし」ステータスのみを持つ空レスポンスを返します。</p><p>最終更新タイムスタンプやif-none-matchヘッダの有無を確認し、完全なレスポンスを返す必要があるかどうかを決定するのは、サーバー側（つまり開発者）の責任です。Railsでは、次のように条件付きGETを簡単に利用できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ProductsController &lt; ApplicationController

  def show
    @product = Product.find(params[:id])

    # 指定のタイムスタンプやetag値によって、リクエストが古いことがわかった場合
    # （再処理が必要な場合）、このブロックを実行
    if stale?(last_modified: @product.updated_at.utc, etag: @product.cache_key)
      respond_to do |wants|
        # ... 通常のレスポンス処理
      end
    end

    # リクエストが新鮮（つまり前回から変更なし）な場合は
    # 処理不要。デフォルトのレンダリングでは、前回の`stale?`呼び出しの結果に基いて
    # 処理が必要かどうかを判断し、
    # :not_modifiedを送信する。以上でおしまい。
  end
end

</pre>
</div>
<p>オプションハッシュの代わりに、単にモデルで渡すこともできます。Railsの<code>last_modified</code>や<code>etag</code>の設定では、<code>updated_at</code>メソッドや<code>cache_key</code>メソッドが使われます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ProductsController &lt; ApplicationController
  def show
    @product = Product.find(params[:id])

    if stale?(@product)
      respond_to do |wants|
        # ... 通常のレスポンス処理
      end
    end
  end
end

</pre>
</div>
<p>特殊なレスポンス処理を行わず、デフォルトのレンダリングメカニズムを使う（つまり<code>respond_to</code>を使ったり独自にレンダリングしたりしない）場合、<code>fresh_when</code>ヘルパーで簡単に処理できます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ProductsController &lt; ApplicationController

  # リクエストが古くなければ自動的に:not_modifiedを返す
  # 古い場合はデフォルトのテンプレート（product.*）を返す

  def show
    @product = Product.find(params[:id])
    fresh_when last_modified: @product.published_at.utc, etag: @product
  end
end

</pre>
</div>
<h4 id="強いetagと弱いetag"><a href="#%E5%BC%B7%E3%81%84etag%E3%81%A8%E5%BC%B1%E3%81%84etag">4.1 強いETagと弱いETag</a></h4><p>Railsでは、デフォルトで「弱い」ETagを使います。弱いETagでは、レスポンスのbodyが微妙に異なっている場合にも同じETagを与えることで、事実上同じレスポンスとして扱えるようになります。レスポンスbodyのごく一部が変更されたときにページの再生成を避けたい場合に便利です。</p><p>弱いETagには<code>W/</code>が付けられ、強いETagと区別できます。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
  W/"618bbc92e2d35ea1945008b42799b0e7" → 弱いETag
  "618bbc92e2d35ea1945008b42799b0e7" → 強いETag

</pre>
</div>
<p>強いETagは、弱いETagと異なり、レスポンスがバイトレベルで完全一致することが求められます。巨大な動画やPDFファイル内でRangeリクエストを実行する場合に便利です。Akamaiなど一部のCDNでは、強いETagのみをサポートしています。強いETagの生成がどうしても必要な場合は、次のようにします。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  class ProductsController &lt; ApplicationController
    def show
      @product = Product.find(params[:id])
      fresh_when last_modified: @product.published_at.utc, strong_etag: @product
    end
  end

</pre>
</div>
<p>次のように、レスポンスに強いETagを直接設定することもできます。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  response.strong_etag = response.body # =&gt; "618bbc92e2d35ea1945008b42799b0e7"

</pre>
</div>
<h3 id="参考資料"><a href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99">5 参考資料</a></h3>
<ul>
<li><a href="https://signalvnoise.com/posts/3113-how-key-based-cache-expiration-works">DHH: キーに基づく有効期限</a></li>
<li><a href="http://railscasts.com/episodes/387-cache-digests">Ryan Bates Railscast: キャッシュダイジェスト</a></li>
</ul>

        

        <h3 id="feedback"><a href="#feedback">フィードバックについて</a></h3>
        <p>
          本ガイドは GitHub上の <a href="https://github.com/yasslab/railsguides.jp">yasslab/railsguides.jp</a> で管理・公開されております。
          本ガイドを読んで気になる文章や間違ったコードを見かけたら、上記リポジトリにてお気軽に <a href="https://github.com/yasslab/railsguides.jp/issues">Issue</a> を出して頂けると嬉しいです。また、「Pull Request を送りたい!」という場合には、<a href="ruby_on_rails_guides_guidelines.html">Ruby on Railsガイドのガイドライン</a>と、<a href="https://github.com/yasslab/railsguides.jp#%E7%BF%BB%E8%A8%B3%E3%81%AE%E6%B5%81%E3%82%8C">README</a>に記載されている「翻訳の流れ」をご参考にしてください。
        </p>
        <p>
          なお、原著における間違いを見つけたら、「Ruby on Railsに貢献する方法」に記されている<a href="/contributing_to_ruby_on_rails.html#rails%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AB%E8%B2%A2%E7%8C%AE%E3%81%99%E3%82%8B">Railsのドキュメントに貢献する</a>を参考にしながら、ぜひRailsコミュニティに貢献してみてしてください :)
        </p>
        <p>
          本ガイドの品質向上に向けて、皆さまのご協力が得られれば幸いです。よろしくお願い致します。
        </p>
        <ol class="snsb" style="margin-left: 0px">
	  <li><div class="fb-like" data-href="http://railsguides.jp/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div></li>
	  <li><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://railsguides.jp/" data-text="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-lang="en" data-hashtags="Railsガイド" data-via="RailsGuidesJP" width="100">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
          <li><iframe src="http://ghbtns.com/github-btn.html?user=yasslab&repo=railsguides.jp&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80" height="20"></iframe></li>
          <li><a href="http://b.hatena.ne.jp/entry/railsguides.jp" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby on Rails ガイド：体系的に Rails を学ぼう" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></li>          
	  <li><div class="g-plusone" data-size="medium" data-lang="ja"></div>
	    <script type="text/javascript">
	      (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	      })();
	    </script>
	  </li>
        </ol>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <div class="sitemap">
          <dl class="L">
            <dt>はじめに</dt>
              <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
            <dt>モデル</dt>
              <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
              <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
              <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
              <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
              <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
              <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
              <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
            <dt>ビュー</dt>
              <dd><a href="action_view_overview.html">Action View の概要</a></dd>
              <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
              <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
            <dt>コントローラ</dt>
              <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
              <dd><a href="routing.html">Rails ルーティング</a></dd>
          </dl>
          <dl class="C">
            <dt>高度なトピック</dt>
              <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
              <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
              <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
              <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
              <dd><a href="testing.html">Rails テスティングガイド</a></dd>
              <dd><a href="security.html">Rails セキュリティガイド</a></dd>
              <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
              <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
              <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
              <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
              <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
              <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
              <dd><a href="autoloading_and_reloading_constants.html">定数の自動読み込みと再読み込み</a></dd>
              <dd><a href="caching_with_rails.html">Rails のキャッシュ: 概要</a></dd>
              <dd><a href="active_support_instrumentation.html">Active Support の Instrumentation 機能</a></dd>
              <dd><a href="profiling.html">Rails アプリケーションのプロファイリング</a></dd>
              <dd><a href="api_app.html">Rails による API 専用アプリ</a></dd>
              <dd><a href="action_cable_overview.html">Action Cable の概要</a></dd>
            <dt>Rails を拡張する</dt>
              <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
              <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
              <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
              <dd><a href="engines.html">Rails エンジン入門</a></dd>
          </dl>
          <dl class="R">
            <dt>Ruby on Rails に貢献する</dt>
              <dd><a href="contributing_to_ruby_on_rails.html">Ruby on Rails に貢献する方法</a></dd>
              <dd><a href="development_dependencies_install.html">Rails コア開発環境の構築方法</a></dd>
              <dd><a href="api_documentation_guidelines.html">API ドキュメント作成ガイドライン</a></dd>
              <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
            <dt>メンテナンスポリシー</dt>
              <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
            <dt>リリースノート</dt>
              <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
              <dd><a href="5_0_release_notes.html">Ruby on Rails 5.0 リリースノート</a></dd>
              <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
              <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
              <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
              <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
              <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
              <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
              <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
              <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
          </dl>
      </div>

      <ol class="snsb" style="padding-top: 20px">
	<li>本ガイドは<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示-継承 4.0 国際</a> (CC BY-SA 4.0) ライセンスに基づいて公開されています。また、「Rails」および「Ruby on Rails」という名称、そして Rails のロゴは、David Heinemeier Hansson による登録商標で、すべての権利を有しています。</li>
      </ol>
    </div>
  </div>
</h5>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-50163209-4', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
